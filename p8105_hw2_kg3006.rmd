---
title: "p8105_hw2_kg3006"
author: "Kevin Guzman"
date: "2025-09-28"
output: github_document
---

## Load Libraries

These are all the libraries for this homework assigment 
```{r}
library(tidyverse)
library(readxl)
library(tigris)
library(sf)
library(ggplot2)
```

## Probelm 1 
Problem 1 uses the FiveThirtyEight data which we will need to upload the pols-month.csv, unempoloyment.csv, and snp.csv. Goal is to merge into a single dataframe using year and month as keys. 
###Cleaning pols-month.csv
#### Load the data
```{r}
pols_month <- 
  read_csv("./fivethirtyeight_datasets/pols-month.csv")
```
Has 9 variables, mon is date, others are all numeric. 

#### Separating Date into year, month, date 
Current structure is "YYYY-MM-DD", we will separate into year, month, day. 
Also will remove the day variable in this step
```{r}
pols_month <- 
  pols_month %>%
  separate(col = mon,
           into = c("year", "month", "day"),
           sep = "-") %>% 
  select(-day)
```

#### Changing month from numeric 
replacing variables in month from numeric value 1-12, to it's corresponding month. 
```{r}
pols_month <- 
  pols_month %>%
  mutate(month = case_when(
    month == "01" ~ "January",
    month == "02" ~ "February",
    month == "03" ~ "March",
    month == "04" ~ "April",
    month == "05" ~ "May",
    month == "06" ~ "June",
    month == "07" ~ "July",
    month == "08" ~ "August",
    month == "09" ~ "September",
    month == "10" ~ "October",
    month == "11" ~ "November",
    month == "12" ~ "December"
  ))
```

#### Create a "president" variable 
Creating a new variable "president" based on prez_gop if 1==gop, and prez_dem if 1=dem. and removing prez_dem and prez_gop.  
```{r}
pols_month <- 
  pols_month %>%
  mutate(president = case_when(
    prez_gop == 1 ~ "gop",
    prez_dem == 1 ~ "dem"
  )) %>%
  select(-prez_gop, -prez_dem)
```

### Cleaning snp.csv 
#### Load the data
```{r}
snp <- 
  read_csv("./fivethirtyeight_datasets/snp.csv")
```
There are two variables here. The first is the date which needs to be cleaned and go to the front, and the second is the close, which is the closing value fo the S&P 500 index. 

#### Separating Date into year, month, date
Current structure is "M/D/YY", we will seperate into year, month, day and remove day. Also making year come first then month
```{r}
snp <- 
  snp %>%
  separate(col = date,
           into = c("month", "day", "year"),
           sep = "/") %>%
  select(-day) %>% 
  select(year, month, everything()) 
```
##### Chaning month from numeric to month name
```{r}
snp <- 
  snp %>%
  mutate(month = case_when(
    month == "1" ~ "January",
    month == "2" ~ "February",
    month == "3" ~ "March",
    month == "4" ~ "April",
    month == "5" ~ "May",
    month == "6" ~ "June",
    month == "7" ~ "July",
    month == "8" ~ "August",
    month == "9" ~ "September",
    month == "10" ~ "October",
    month == "11" ~ "November",
    month == "12" ~ "December"
  ))
```

##### Year needs to match prior 
Year here has 2 digits, need to make it 4 digits to match prior dataframes by adding 19 to characters 50 - 99 and 20 to characters 00 - 25.
```{r}
snp <- 
  snp %>%
  mutate(year = case_when(
    as.integer(year) >= 50 ~ paste0("19", year),
    as.integer(year) <= 25 ~ paste0("20", year)
  ))
```

### Cleaning unemployment.csv
#### Load the data
```{r}
unemployment <-
  read_csv("./fivethirtyeight_datasets/unemployment.csv")
```
There are 13 columns, the first is Year which is numeric and needs to change to character

#### Changing Year
Changing from numeric to character 
```{r}
unemployment <-
  unemployment %>%
  mutate(Year = as.character(Year))
```
It also needs to be renamed from Year to year to match other dataframes
```{r}
unemployment <-
  unemployment %>%
  rename(year = Year)
```

### Changing month 
Month data representes the percent of unepolyment in each month. This will need to be pivoted from wide to long format  for month
```{r}
unemployment <-
  unemployment %>%
  pivot_longer(cols = Jan:Dec,
               names_to = "month",
               values_to = "unemployment_rate")
```
I will also need to chagne month from shorten 3 word name to full name 
```{r}
unemployment <-
  unemployment %>%
  mutate(month = case_when(
    month == "Jan" ~ "January",
    month == "Feb" ~ "February",
    month == "Mar" ~ "March",
    month == "Apr" ~ "April",
    month == "May" ~ "May",
    month == "Jun" ~ "June",
    month == "Jul" ~ "July",
    month == "Aug" ~ "August",
    month == "Sep" ~ "September",
    month == "Oct" ~ "October",
    month == "Nov" ~ "November",
    month == "Dec" ~ "December"
  ))
```

### Merging all three dataframes
Now that all three dataframes are cleaned, we can merge them using year and month as keys with left_join
```{r}
merged_data <-
  pols_month %>%
  left_join(snp, by = c("year", "month")) %>%
  left_join(unemployment, by = c("year", "month"))
```

### Description of datasets 
This combined dataset contines information gathered from the FiveThirtyEight data. Each dataset is arranged into year of month of the data. The pols_month dataset was informative in the party affiliation of the president in power during each year-month time interval. It also contains infomration on the number of senators, representitives, and governers during this time period. The snp dataset contains each year-month closing value of the S&P 500 index, and finally the unempolymenbt dataset contains the unemployment rate for each year-month time interval.

The **dimentions of the dataset** are `r nrow(merged_data)` observations and `r ncol(merged_data)` variables/columns.

**Key variables include**:  
- year  
- month  
- president  
- close (S&P 500 closing value)  
- unemployment_rate  

The dataset **starts on `r first(merged_data$year)` and ends in `r last(merged_data$year)`**.

## Problem 2 
In this problem we use the excel file 2024_09_Trash_Wheel_Data.xlsx which as 3 sheets of importance "Mr. Trash Wheel", "Professor Trash Wheel", and "Gwynnda Trash Wheel". We will clean each sheet seperately and then merge. 

### Loading Mr. Trashweel data 
Specification include cleaning column names, removing columns that are missing, removing rows without dumpsters, adding dataset for merging, reorganizing, and making sport balls into integers. 

In addition there seems to be a problem in the datasets formating.   
- year - all should be character  
- 
```{r}
mr_trash_wheel <- 
  read_excel("./Trash/2024_09_Trash_Wheel_Data.xlsx",
                     sheet = "Mr. Trash Wheel") %>% 
  select(-...15, -...16) %>% 
  janitor::clean_names() %>% 
  mutate (dataset="mr_trash_wheel") %>% 
  select(year, month, dataset, everything()) %>% 
  filter(!is.na(dumpster)) %>% 
  mutate(sports_balls = as.integer(round(sports_balls)))
```

### Loading Professor Trash Wheel data
Column names here need to be cleaned, there are no additional variables that are added too so we don't have to remove those columns. There is also no sports balls, so we don't have to create that step
```{r}
professor_trash_wheel <-
  read_excel("./Trash/2024_09_Trash_Wheel_Data.xlsx",
                     sheet = "Professor Trash Wheel") %>% 
  janitor::clean_names() %>% 
  mutate (dataset="professor_trash_wheel") %>%
  select(year, month, dataset, everything()) %>%
  filter(!is.na(dumpster)) %>% 
  mutate(year = as.character(year))


```
### Loading Gwynnda Trash Wheel data
Similar here, no additional columns created and there is no sports ball variable to mutate. 
```{r}
gwynnda_trash_wheel <-
  read_excel("./Trash/2024_09_Trash_Wheel_Data.xlsx",
                     sheet = "Gwynnda Trash Wheel") %>% 
  janitor::clean_names() %>% 
  mutate (dataset="gwynnda_trash_wheel") %>%
  select(year, month, dataset, everything()) %>%
  filter(!is.na(dumpster)) %>% 
  mutate(year = as.character(year))
```

All data has month, year dumpster. We will go through each one and then merge by month and year. 

### Join rows for all datasets
Joining all datasets by rows 
```{r}
trash_wheel_data <-
  bind_rows(mr_trash_wheel,
            professor_trash_wheel,
            gwynnda_trash_wheel)
```

### Description of dataset
This combined dataset contains information on the amount of trash collected by three different trash wheels in Baltimore. There are a **total** of `r nrow(trash_wheel_data)` observations and `r ncol(trash_wheel_data)` variables/columns. The key variables include:  
- year  
- month  
- dataset (which trash wheel)   
- dumpster (number of dumpsters collected)  
- plastic_bottles  
- plastic_bags  
- sports_balls (only for Mr. Trash Wheel)  

The dataset starts on `r first(trash_wheel_data$year)` and ends in `r last(trash_wheel_data$year)`. There are `r nrow(trash_wheel_data %>% filter(dataset=="mr_trash_wheel"))` observations from Mr. Trash Wheel, `r nrow(trash_wheel_data %>% filter(dataset=="professor_trash_wheel"))` observations from Professor Trash Wheel, and `r nrow(trash_wheel_data %>% filter(dataset=="gwynnda_trash_wheel"))` observations from Gwynnda Trash Wheel.

The **total weight of trash collected by professor trash wheel** was `r trash_wheel_data %>% filter(dataset=="professor_trash_wheel") %>% summarise(total = sum(weight_tons, na.rm=TRUE)*2000) %>% pull(total)` pounds. In addition, the **total number of cigarettes butts collected by Gwynnda in June of 2022** was `r trash_wheel_data %>% filter(dataset=="gwynnda_trash_wheel") %>% filter(year=="2022") %>% filter(month=="June") %>% summarise(total2 = sum(cigarette_butts, na.rm=TRUE)) %>% pull(total2)` butts.

## Problem 3 Zillow 
We will be using zillow data here 

### Loading the data
Uploading the data and cleaning the names with janitor 
```{r}
zillow_zip <-
  read_csv("./Zillow/Zip Codes.csv") %>% 
  janitor::clean_names()
```
This dataset contains 7 variables and 322 observations.

```{r}
zori <-
  read_csv("./Zillow/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv") %>% 
  janitor::clean_names()
```
149 observations with 125 variables. Most variables are dates with long format

### Stating to Clean 
We are specifically analyzing NYC between Janurary 2015 and August 2024. 

#### Cleaning zillow_zip
##### County 
First we look at data 
```{r}
table(zillow_zip$county) # 149 New York, 48 Kings, 30 Bronx, Queens 81, Richmond 14 
any(is.na(zillow_zip$county)) # No missing values
```
There are no missing data. 

##### State FIPS 
Looking at the data: Will change state to New York if 36
```{r}
table(zillow_zip$state_fips) # not a useful data and so will remove 
any(is.na(zillow_zip$state_fips)) # No missing values

zillow_zip <- zillow_zip %>% 
  mutate(state = case_when(
     state_fips == 36 ~ "New York",
     TRUE ~ as.character(state_fips)
  )) %>% 
    select(-state_fips)
```

There are no missing values and all are New York 

##### County_code 
Looking at county code 
```{r}
table(zillow_zip$county_code) # not a useful data and so will remove
any(is.na(zillow_zip$county_code)) # No missing values
table(zillow_zip$county_code, zillow_zip$county) #  all county codes match with one county. 
```
All counties match up wtih the county code, this is a redundent variables so I will remove it. 
```{r}
zillow_zip <- zillow_zip %>%
  select(-county_code)
```

##### County_fips
Looking at county fips
```{r}
table(zillow_zip$county_fips) # not a useful data and so will remove
table(zillow_zip$county_fips, zillow_zip$county) # all county fips match with one county. 
```
All counties match up wtih the county fips, this is a redundent variables so I will remove it. 
```{r}
zillow_zip <- zillow_zip %>%
  select(-county_fips)
```

##### Zip_code
Looking at zip code
```{r}
table(zillow_zip$zip_code) # zip codes make sense 
any(is.na(zillow_zip$zip_code)) # No missing values
```
There are many zip codes. They all make sense from 10001-11697

##### File_date 
Looking at file date. All the file date is 07/25/07, this is also not useful, so will remove it. 
```{r}
table(zillow_zip$file_date) # all 7/25/07, will remove 
zillow_zip <- zillow_zip %>%
  select(-file_date)
```


##### neighbrohood 
Looking at neighborhood
```{r}
any(is.na(zillow_zip$neighborhood)) # There are missing values 
```
Some missing variables
mapping out which neighborhoods are in each county 
```{r}
table(zillow_zip$neighborhood, zillow_zip$county) # there are some neighborhoods with two different countires.
#Finding neighborhoods with more than one county
zillow_zip %>%
  group_by(neighborhood) %>%
  summarise(n_counties = n_distinct(county)) %>%
  filter(n_counties > 1)
# there are 5 missing, will leave as is.
#Kingsbridge and riverdale is in the bronx 
#Nortwhest Brooklyn is in kings 
#Rockaways should also be in queens not 
```
##### looking at zipcodes fore each neighborhood with multiple counties
```{r}
zillow_zip %>%
  filter(neighborhood %in% c("Kingsbridge and Riverdale", "Northwest Brooklyn", "Rockaways")) %>%
  select(neighborhood, county, zip_code)
#If 11201 then should be Kings for county 
#If 10463 then should be Bronx for county
#If 11693 then should be Queens for county
zillow_zip <- zillow_zip %>%
  mutate(county = case_when(
    neighborhood == "Kingsbridge and Riverdale" & zip_code == 10463 ~ "Bronx",
    neighborhood == "Northwest Brooklyn" & zip_code == 11201 ~ "Kings",
    neighborhood == "Rockaways" & zip_code == 11693 ~ "Queens",
    TRUE ~ county
  )) %>% 
  select(zip_code, state, county, everything())
```

####Cleaning zori 
##### zip_code (region_name) 
Looking at region_name and region_type 
```{r}
#Region type
table(zori$region_type) # all zip codes, will remove eventually 
any(is.na(zori$region_name)) # No missing values

#Region name - already as numeric, however will need to rename for consistency 
table(zori$region_name) # All zipcode are within a range that makes sense (10001-11697)

zori <- zori %>%
  rename(zip_code = region_name) %>%
  select(-region_type)
```
All zipcode are within a range that makes sense (10001-11697). Needed to rename to zip_code from region_name. 

We will also look if all zip_codes in zori are present in zillow_zip. 
```{r}
all(zori$zip_code %in% zillow_zip$zip_code) # TRUE, all are present 
```
Since all are present, we do not need state name, county name, or region, city, or metro and will remove all of them. 

##### Removing unnecessary variables about location 
```{r}
zori <- zori %>%
  select(zip_code, size_rank, everything()) %>% 
  select(-(region_id:county_name))
```

##### Looking at size_rank 
Looking for missing
```{r}
#Missing
any(is.na(zori$size_rank)) # No missing values
```

##### Dealing with dates 
This data is the ZORI data which is a measure of typical observed rental market engagement. It is arrange into columns by date. We should piviot it so that it instead we will have two rows, one for the date and the other for the ZORI. Date should also be changed to mm/dd/yyyy format.
```{r}
zori <- zori %>%
  pivot_longer(cols = starts_with("x"),
               names_to = "date",
               values_to = "zori") %>%
  mutate(date = str_remove(date, "x")) %>%
  mutate(date = as.Date(date, format="%Y_%m_%d"))
```

### Merging zillow_zip and zori
Merging by zip_code. Will use inner_join to keep only zip codes that are in both datasets.
```{r}
zillow_data <-
  zillow_zip %>%
  inner_join(zori, by = "zip_code", relationship = "many-to-many") 
```

### Describing the dataset 
This dataset has **`r nrow(zillow_data)` observations** and `r ncol(zillow_data)` variables/columns.
- zip_code  
- state  
- county  
- neighborhood  
- size_rank  
- date (date of teh ZORI data)  
- zori  

There are **`r unique(zillow_data$zip_code) %>% length()` unique zip codes** in the dataset. And there are **`r unique(zillow_data$neighborhood) %>% length()` unique neighborhoods** in the dataset.

### Zipcodes compariosn between datasets
There are **`r (unique(zillow_zip$zip_code) %>% length()) - (unique(zori$zip_code) %>% length())` zip codes** that are in the zillow_zip dataset but not in the zori dataset. These are: 
```{r, echo=FALSE}
setdiff(zillow_zip$zip_code, zori$zip_code)
```
The map of these zip codes show that these are primarily in the outskirts of NYC. 
```{r, echo=FALSE, message=FALSE, warning=FALSE}
#missing dataframe
missing_zips <- setdiff(zillow_zip$zip_code, zori$zip_code)
missing_df <- zillow_zip %>% filter(zip_code %in% missing_zips)
#map
ny_zips <- zctas(state = "NY", year = 2010, cb = FALSE)
#change ZCTA5CE10 to zip_code and numeric
ny_zips <- ny_zips %>%
  mutate(zip_code = as.numeric(ZCTA5CE10)) %>%
  select(-ZCTA5CE10)
#keep only zip codes that are preseent in missing_df
missing_zips_sf <- ny_zips %>%
  inner_join(missing_df, by = "zip_code")
#zip codes present
present_zips_sf <- ny_zips %>%
  inner_join(zori, by = "zip_code")
#plotting
ggplot() +
  # Base layer: all present ZIPs
  geom_sf(data = present_zips_sf, fill = "grey80", color = "white") +
  # Highlight missing ZIPs
  geom_sf(data = missing_zips_sf, fill = "red", color = "black") +
  labs(title = "ZIP Codes in Zillow but Missing in ZORI (NY only)")
```


